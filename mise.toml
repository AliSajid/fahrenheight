# mise configuration for fahrenheight project
# https://mise.jdx.dev/

[tools]
node = "22.20.0"
"npm:wrangler" = "4.45.4"
pnpm = "10.20.0"
pre-commit = "4.3.0"

"ubi:cocogitto/cocogitto" = { version = "6.4.0", exe = "cog" }

[env]
NODE_ENV = "development"
'_'.file = { path = ".env" }

[tasks.dev]
description = "Start development server"
run = "pnpm exec vite dev"

[tasks.dev-open]
description = "Start development server and open browser"
run = "pnpm exec vite dev --open"

[tasks.build]
description = "Build static site for production"
run = "pnpm exec vite build"

[tasks.preview]
description = "Preview production build locally"
run = "pnpm exec vite preview"

[tasks.check]
description = "Type-check with svelte-check"
run = "pnpm exec svelte-kit sync && pnpm exec svelte-check --tsconfig ./tsconfig.json"

[tasks.check-watch]
description = "Type-check with svelte-check in watch mode"
run = "pnpm exec svelte-kit sync && pnpm exec svelte-check --tsconfig ./tsconfig.json --watch"

[tasks.lint]
description = "Lint and check code with ESLint and Prettier (no fixes)"
run = "pnpm exec prettier --check . && pnpm exec eslint ."

[tasks."lint:check"]
description = "Check code with ESLint and Prettier (alias for lint)"
run = "pnpm exec prettier --check . && pnpm exec eslint ."

[tasks.format]
description = "Format code with Prettier (write changes)"
run = "pnpm exec prettier --write ."

[tasks."format:check"]
description = "Check code formatting with Prettier (no changes)"
run = "pnpm exec prettier --check ."

[tasks.test]
description = "Run all tests (unit + e2e)"
run = "pnpm exec vitest --run && pnpm exec playwright test"

[tasks.test-unit]
description = "Run unit tests with Vitest"
run = "pnpm exec vitest"

[tasks.test-e2e]
description = "Run E2E tests with Playwright"
run = "pnpm exec playwright test"

[tasks.install]
description = "Install dependencies"
run = "pnpm install"

[tasks.sync]
description = "Sync SvelteKit types"
run = "pnpm exec svelte-kit sync || echo ''"

[tasks.ci]
description = "Run CI checks (lint, type-check, test)"
depends = ["lint:check", "format:check", "check", "test"]

[tasks.changelog]
description = "Generate changelog for current version"
run = """
#!/usr/bin/env bash
set -euo pipefail

VERSION="${VERSION:-latest}"
PREV_TAG="${PREV_TAG:-}"

if [[ "$VERSION" == "latest" ]]; then
    VERSION=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")
fi

if [[ -n "$PREV_TAG" ]]; then
    cog changelog --at "$VERSION" "${PREV_TAG}..${VERSION}"
else
    PREV=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
    if [[ -n "$PREV" ]]; then
        cog changelog --at "$VERSION" "${PREV}..${VERSION}"
    else
        cog changelog --at "$VERSION"
    fi
fi
"""

[tasks.create-checksums]
description = "Create SHA256 checksums for a file"
run = """
#!/usr/bin/env bash
set -euo pipefail

FILE="${1:?Usage: mise run create-checksums <file>}"

if [[ ! -f "$FILE" ]]; then
    echo "Error: File $FILE not found"
    exit 1
fi

echo "Creating checksum for: $FILE"

# Create SHA256 checksum
sha256sum "$FILE" | tee SHA256SUMS.txt

echo "Checksum created:"
cat SHA256SUMS.txt
"""
