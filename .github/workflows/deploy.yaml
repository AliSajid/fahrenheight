name: Deploy to Cloudflare Pages

on:
    push:
        branches:
            - main
            - next

permissions:
    contents: read
    pull-requests: read

jobs:
    build:
        name: Build Static Site
        runs-on: ubuntu-latest
        outputs:
            deployment-type: ${{ steps.deployment-type.outputs.type }}
            branch-name: ${{ steps.deployment-type.outputs.branch-name }}
            target-branch: ${{ steps.deployment-type.outputs.branch }}
        steps:
            - name: Harden Runner
              uses: step-security/harden-runner@91182cccc01eb5e619899d80e4e971d6181294a7 # v2.10.1
              with:
                  disable-sudo: true
                  egress-policy: block
                  allowed-endpoints: >
                      api.github.com:443
                      github.com:443
                      mise.jdx.dev:443
                      objects.githubusercontent.com:443
                      registry.npmjs.org:443

            - name: Checkout repository
              uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

            - name: Install mise
              uses: jdx/mise-action@f8dfbcc150159126838e44b882bf34bd98fd90f3 # v2.1.0
              with:
                  install_args: --yes

            - name: Install dependencies
              run: mise run install

            - name: Sync SvelteKit
              run: mise run sync

            - name: Build static site
              run: mise run build

            - name: Determine deployment type
              id: deployment-type
              run: |
                  # For pushes, use the actual branch name
                  BRANCH="${{ github.ref_name }}"

                  echo "branch=$BRANCH" >> $GITHUB_OUTPUT

                  if [[ "$BRANCH" == "main" ]]; then
                      echo "type=production" >> $GITHUB_OUTPUT
                      echo "branch-name=main" >> $GITHUB_OUTPUT
                      echo "ðŸ“¦ Build complete for production deployment" >> $GITHUB_STEP_SUMMARY
                  elif [[ "$BRANCH" == "next" ]]; then
                      echo "type=next" >> $GITHUB_OUTPUT
                      echo "branch-name=next" >> $GITHUB_OUTPUT
                      echo "ðŸ“¦ Build complete for next preview deployment" >> $GITHUB_STEP_SUMMARY
                  else
                      echo "type=preview" >> $GITHUB_OUTPUT
                      echo "branch-name=$BRANCH" >> $GITHUB_OUTPUT
                      echo "ðŸ“¦ Build complete for preview deployment: $BRANCH" >> $GITHUB_STEP_SUMMARY
                  fi

            - name: Create deployment artifact
              run: |
                  cd build
                  zip -r ../build-artifact.zip .
                  cd ..
                  echo "ðŸ“¦ Created build artifact: $(du -h build-artifact.zip | cut -f1)" >> $GITHUB_STEP_SUMMARY

            - name: Upload build artifact
              uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4 # v5.0.0
              with:
                  name: build-artifact
                  path: build-artifact.zip
                  retention-days: 1
                  compression-level: 0 # Already compressed

    deploy-production:
        name: Deploy to Production
        needs: build
        if: needs.build.outputs.deployment-type == 'production'
        runs-on: ubuntu-latest
        environment:
            name: production
            url: https://fahrenheight.pages.dev
        concurrency:
            group: cloudflare-pages-production
            cancel-in-progress: false
        steps:
            - name: Harden Runner
              uses: step-security/harden-runner@91182cccc01eb5e619899d80e4e971d6181294a7 # v2.10.1
              with:
                  disable-sudo: true
                  egress-policy: block
                  allowed-endpoints: >
                      api.github.com:443
                      github.com:443
                      api.cloudflare.com:443
                      registry.npmjs.org:443
                      objects.githubusercontent.com:443

            - name: Install mise
              uses: jdx/mise-action@f8dfbcc150159126838e44b882bf34bd98fd90f3 # v2.1.0
              with:
                  install_args: --yes
                  mise_toml: |
                      [tools]
                      node = "22"
                      "npm:wrangler" = "4.45.4"

            - name: Download build artifact
              uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16 # v4.1.8
              with:
                  name: build-artifact

            - name: Extract build artifact
              run: |
                  mkdir -p build
                  unzip -q build-artifact.zip -d build
                  echo "ðŸ“¦ Extracted build artifact" >> $GITHUB_STEP_SUMMARY

            - name: Deploy to Cloudflare Pages
              run: |
                  wrangler pages deploy build \
                      --project-name=fahrenheight \
                      --branch=main \
                      --commit-hash="${{ github.sha }}" \
                      --commit-message="${{ github.event.head_commit.message }}"
              env:
                  CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
                  CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

            - name: Deployment Summary
              run: |
                  echo "## âœ… Production Deployment Complete" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "**Branch:** ${{ needs.build.outputs.target-branch }}" >> $GITHUB_STEP_SUMMARY
                  echo "**Commit:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "### ðŸŒ Production URL" >> $GITHUB_STEP_SUMMARY
                  echo "[https://fahrenheight.pages.dev](https://fahrenheight.pages.dev)" >> $GITHUB_STEP_SUMMARY

    deploy-next:
        name: Deploy to Next Preview
        needs: build
        if: needs.build.outputs.deployment-type == 'next'
        runs-on: ubuntu-latest
        environment:
            name: next
            url: https://next.fahrenheight.pages.dev
        concurrency:
            group: cloudflare-pages-next
            cancel-in-progress: false
        steps:
            - name: Harden Runner
              uses: step-security/harden-runner@91182cccc01eb5e619899d80e4e971d6181294a7 # v2.10.1
              with:
                  disable-sudo: true
                  egress-policy: block
                  allowed-endpoints: >
                      api.github.com:443
                      github.com:443
                      api.cloudflare.com:443
                      registry.npmjs.org:443
                      objects.githubusercontent.com:443

            - name: Install mise
              uses: jdx/mise-action@f8dfbcc150159126838e44b882bf34bd98fd90f3 # v2.1.0
              with:
                  install_args: --yes
                  mise_toml: |
                      [tools]
                      node = "22"
                      "npm:wrangler" = "4.45.4"

            - name: Download build artifact
              uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16 # v4.1.8
              with:
                  name: build-artifact

            - name: Extract build artifact
              run: |
                  mkdir -p build
                  unzip -q build-artifact.zip -d build
                  echo "ðŸ“¦ Extracted build artifact" >> $GITHUB_STEP_SUMMARY

            - name: Deploy to Cloudflare Pages
              run: |
                  wrangler pages deploy build \
                      --project-name=fahrenheight \
                      --branch=next \
                      --commit-hash="${{ github.sha }}" \
                      --commit-message="${{ github.event.head_commit.message }}"
              env:
                  CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
                  CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

            - name: Deployment Summary
              run: |
                  echo "## âœ… Next Preview Deployment Complete" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "**Branch:** ${{ needs.build.outputs.target-branch }}" >> $GITHUB_STEP_SUMMARY
                  echo "**Commit:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "### ðŸŒ Preview URL (Fixed)" >> $GITHUB_STEP_SUMMARY
                  echo "[https://next.fahrenheight.pages.dev](https://next.fahrenheight.pages.dev)" >> $GITHUB_STEP_SUMMARY

    deploy-preview:
        name: Deploy to Preview
        needs: build
        if: needs.build.outputs.deployment-type == 'preview'
        runs-on: ubuntu-latest
        environment:
            name: preview-${{ needs.build.outputs.branch-name }}
        concurrency:
            group: cloudflare-pages-preview-${{ needs.build.outputs.branch-name }}
            cancel-in-progress: false
        steps:
            - name: Harden Runner
              uses: step-security/harden-runner@91182cccc01eb5e619899d80e4e971d6181294a7 # v2.10.1
              with:
                  disable-sudo: true
                  egress-policy: block
                  allowed-endpoints: >
                      api.github.com:443
                      github.com:443
                      api.cloudflare.com:443
                      registry.npmjs.org:443
                      objects.githubusercontent.com:443

            - name: Install mise
              uses: jdx/mise-action@f8dfbcc150159126838e44b882bf34bd98fd90f3 # v2.1.0
              with:
                  install_args: --yes
                  mise_toml: |
                      [tools]
                      node = "22"
                      "npm:wrangler" = "4.45.4"

            - name: Download build artifact
              uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16 # v4.1.8
              with:
                  name: build-artifact

            - name: Extract build artifact
              run: |
                  mkdir -p build
                  unzip -q build-artifact.zip -d build
                  echo "ðŸ“¦ Extracted build artifact" >> $GITHUB_STEP_SUMMARY

            - name: Deploy to Cloudflare Pages
              run: |
                  wrangler pages deploy build \
                      --project-name=fahrenheight \
                      --branch="${{ needs.build.outputs.branch-name }}" \
                      --commit-hash="${{ github.sha }}" \
                      --commit-message="${{ github.event.head_commit.message }}"
              env:
                  CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
                  CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

            - name: Deployment Summary
              run: |
                  echo "## âœ… Preview Deployment Complete" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "**Branch:** ${{ needs.build.outputs.branch-name }}" >> $GITHUB_STEP_SUMMARY
                  echo "**Commit:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "### ðŸŒ Preview URL" >> $GITHUB_STEP_SUMMARY
                  echo "Preview URL will be available in Cloudflare Pages dashboard" >> $GITHUB_STEP_SUMMARY

    release-production:
        name: Create Production Release
        needs: [build, deploy-production]
        if: needs.build.outputs.deployment-type == 'production'
        uses: ./.github/workflows/release.yaml
        secrets: inherit # pragma: allowlist secret
        with:
            branch: main
            artifact-name: build-artifact
        permissions:
            contents: write
            id-token: write
            attestations: write
            actions: read

    release-next:
        name: Create Next Release
        needs: [build, deploy-next]
        if: needs.build.outputs.deployment-type == 'next'
        uses: ./.github/workflows/release.yaml
        secrets: inherit # pragma: allowlist secret
        with:
            branch: next
            artifact-name: build-artifact
        permissions:
            contents: write
            id-token: write
            attestations: write
            actions: read
