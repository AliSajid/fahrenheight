name: Deploy (Tag-first) with Wrangler

on:
    push:
        tags:
            - 'v*'
        branches:
            - '**'

permissions:
    contents: read
    pull-requests: read

jobs:
    build-from-tag:
        if: startsWith(github.ref, 'refs/tags/')
        uses: ./.github/workflows/build-and-package.yaml

    deploy-from-tag:
        needs: build-from-tag
        if: startsWith(github.ref, 'refs/tags/')
        runs-on: ubuntu-latest
        environment:
            name: ${{ contains(github.ref_name, '-next') && 'next' || 'production' }}
        concurrency:
            group: ${{ contains(github.ref_name, '-next') && 'cloudflare-pages-next' || 'cloudflare-pages-production' }}
            cancel-in-progress: false
        steps:
            - name: Harden Runner
              uses: step-security/harden-runner@91182cccc01eb5e619899d80e4e971d6181294a7 # v2.10.1
              with:
                  disable-sudo: true
                  egress-policy: block
                  allowed-endpoints: |
                      api.github.com:443
                      github.com:443
                      api.cloudflare.com:443
                      registry.npmjs.org:443
                      objects.githubusercontent.com:443

            - name: Install mise
              uses: jdx/mise-action@f8dfbcc150159126838e44b882bf34bd98fd90f3 # v2.1.0
              with:
                  install_args: --yes

            - name: Install Wrangler CLI
              shell: bash
              run: |
                  mise use -g node@22
                  npm i -g wrangler@4.45.4

            - name: Download build artifact
              uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16 # v4.1.8
              with:
                  name: build-artifact

            - name: Extract build artifact
              shell: bash
              run: |
                  mkdir -p build
                  unzip -q build-artifact.zip -d build

            - name: Determine deploy branch
              id: branch
              shell: bash
              run: |
                  TAG="${GITHUB_REF_NAME}"
                  if [[ "$TAG" == *"-next"* ]]; then
                      echo "deploy_branch=next" >> $GITHUB_OUTPUT
                  else
                      echo "deploy_branch=main" >> $GITHUB_OUTPUT
                  fi

            - name: Deploy with Wrangler
              env:
                  CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
                  CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
              shell: bash
              run: |
                  wrangler pages deploy build \
                      --project-name=fahrenheight \
                      --branch="${{ steps.branch.outputs.deploy_branch }}" \
                      --commit-hash="${{ github.sha }}" \
                      --commit-message="${{ github.ref_name }}"

    release-from-tag:
        needs: [build-from-tag, deploy-from-tag]
        if: startsWith(github.ref, 'refs/tags/')
        runs-on: ubuntu-latest
        permissions:
            contents: write
            id-token: write
            attestations: write
        steps:
            - name: Harden Runner
              uses: step-security/harden-runner@91182cccc01eb5e619899d80e4e971d6181294a7 # v2.10.1
              with:
                  disable-sudo: true
                  egress-policy: block
                  allowed-endpoints: |
                      api.github.com:443
                      github.com:443
                      mise.jdx.dev:443
                      objects.githubusercontent.com:443
                      registry.npmjs.org:443
                      uploads.github.com:443
                      fulcio.sigstore.dev:443
                      rekor.sigstore.dev:443
                      tuf-repo-cdn.sigstore.dev:443
                      keys.openpgp.org:443

            - name: Checkout tag
              uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
              with:
                  fetch-depth: 0

            - name: Download build artifact
              uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16 # v4.1.8
              with:
                  name: build-artifact

            - name: Prepare release bundle
              id: bundle
              shell: bash
              run: |
                  VERSION="${GITHUB_REF_NAME}"
                  ART="fahrenheight-${VERSION}.zip"
                  mv build-artifact.zip "$ART"
                  echo "VERSION=$VERSION" >> $GITHUB_ENV
                  echo "ARTIFACT=$ART" >> $GITHUB_ENV
                  sha256sum "$ART" > SHA256SUMS.txt

            - name: Import GPG key
              uses: crazy-max/ghaction-import-gpg@01dd5d3ca463c7f10f7f4f7b4f177225ac661ee4 # v6.1.0
              with:
                  gpg_private_key: ${{ secrets.GPG_PRIVATE_KEY }}
                  passphrase: ${{ secrets.GPG_KEY_PASSPHRASE }}
                  trust_level: ultimate
                  fingerprint: ${{ secrets.GPG_SUBKEY_FINGERPRINT }}
                  git_user_signingkey: true
                  git_commit_gpgsign: true
                  git_tag_gpgsign: false
                  git_committer_name: ${{ vars.GIT_AUTHOR_NAME }}
                  git_committer_email: ${{ vars.GIT_AUTHOR_EMAIL }}

            - name: Sign artifacts
              shell: bash
              run: |
                  gpg --batch --yes --detach-sign --armor "$ARTIFACT"
                  gpg --batch --yes --detach-sign --armor SHA256SUMS.txt

            - name: Assemble release notes
              shell: bash
              run: |
                  cp CHANGELOG.md release_notes.md || echo "# Release ${VERSION}" > release_notes.md
                  {
                      echo
                      echo "## Verification"
                      echo
                      echo '```bash'
                      echo "wget https://github.com/${{ github.repository }}/releases/download/${VERSION}/${ARTIFACT}"
                      echo "wget https://github.com/${{ github.repository }}/releases/download/${VERSION}/${ARTIFACT}.asc"
                      echo "wget https://github.com/${{ github.repository }}/releases/download/${VERSION}/SHA256SUMS.txt"
                      echo "wget https://github.com/${{ github.repository }}/releases/download/${VERSION}/SHA256SUMS.txt.asc"
                      echo "gpg --keyserver keys.openpgp.org --recv-keys <KEY_ID>"
                      echo "gpg --verify ${ARTIFACT}.asc ${ARTIFACT}"
                      echo "sha256sum -c SHA256SUMS.txt"
                      echo '```'
                  } >> release_notes.md

            - name: Create GitHub Release
              uses: softprops/action-gh-release@c062e08bd532815e2082a85e87e3ef29c3e6d191 # v2.0.8
              with:
                  tag_name: ${{ github.ref_name }}
                  name: fahrenheight-${{ github.ref_name }}
                  body_path: release_notes.md
                  prerelease: ${{ contains(github.ref_name, '-next') }}
                  files: |
                      fahrenheight-${{ github.ref_name }}.zip
                      fahrenheight-${{ github.ref_name }}.zip.asc
                      SHA256SUMS.txt
                      SHA256SUMS.txt.asc
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

            - name: Attest provenance
              uses: actions/attest-build-provenance@1c608d11d69870c2092266b3f9a6f3abbf17002c # v1.4.3
              with:
                  subject-path: |
                      fahrenheight-${{ github.ref_name }}.zip
                      SHA256SUMS.txt

    build-preview:
        if: startsWith(github.ref, 'refs/heads/') && github.ref_name != 'main' && github.ref_name != 'next'
        uses: ./.github/workflows/build-and-package.yaml

    deploy-preview:
        needs: build-preview
        if: startsWith(github.ref, 'refs/heads/') && github.ref_name != 'main' && github.ref_name != 'next'
        runs-on: ubuntu-latest
        environment:
            name: preview-${{ github.ref_name }}
        concurrency:
            group: cloudflare-pages-preview-${{ github.ref_name }}
            cancel-in-progress: false
        steps:
            - name: Harden Runner
              uses: step-security/harden-runner@91182cccc01eb5e619899d80e4e971d6181294a7 # v2.10.1
              with:
                  disable-sudo: true
                  egress-policy: block
                  allowed-endpoints: |
                      api.github.com:443
                      github.com:443
                      api.cloudflare.com:443
                      registry.npmjs.org:443
                      objects.githubusercontent.com:443

            - name: Install mise
              uses: jdx/mise-action@f8dfbcc150159126838e44b882bf34bd98fd90f3 # v2.1.0
              with:
                  install_args: --yes

            - name: Install Wrangler CLI
              shell: bash
              run: |
                  mise use -g node@22
                  npm i -g wrangler@4.45.4

            - name: Download build artifact
              uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16 # v4.1.8
              with:
                  name: build-artifact

            - name: Extract build artifact
              shell: bash
              run: |
                  mkdir -p build
                  unzip -q build-artifact.zip -d build

            - name: Deploy with Wrangler (preview)
              env:
                  CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
                  CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
              shell: bash
              run: |
                  wrangler pages deploy build \
                      --project-name=fahrenheight \
                      --branch="${{ github.ref_name }}" \
                      --commit-hash="${{ github.sha }}"
