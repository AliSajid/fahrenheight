name: Release

on:
    workflow_call:
        inputs:
            branch:
                description: 'Branch name (main or next)'
                required: true
                type: string
            artifact-name:
                description: 'Name of the build artifact'
                required: true
                type: string
                default: 'build-artifact'
    workflow_dispatch:
        inputs:
            create-build:
                description: 'Build the project before creating release'
                required: false
                type: boolean
                default: true

permissions:
    contents: write
    id-token: write
    attestations: write
    actions: read

jobs:
    build-manual:
        name: Build for Manual Release
        runs-on: ubuntu-latest
        if: github.event_name == 'workflow_dispatch' && inputs.create-build == true
        steps:
            - name: Harden Runner
              uses: step-security/harden-runner@91182cccc01eb5e619899d80e4e971d6181294a7 # v2.10.1
              with:
                  disable-sudo: true
                  egress-policy: block
                  allowed-endpoints: >
                      api.github.com:443
                      github.com:443
                      mise.jdx.dev:443
                      objects.githubusercontent.com:443
                      registry.npmjs.org:443

            - name: Checkout repository
              uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

            - name: Install mise
              uses: jdx/mise-action@f8dfbcc150159126838e44b882bf34bd98fd90f3 # v2.1.0
              with:
                  install_args: --yes

            - name: Install dependencies
              run: mise run install

            - name: Sync SvelteKit
              run: mise run sync

            - name: Build static site
              run: mise run build

            - name: Create deployment artifact
              run: |
                  cd build
                  zip -r ../build-artifact.zip .
                  cd ..
                  echo "ðŸ“¦ Created build artifact: $(du -h build-artifact.zip | cut -f1)" >> $GITHUB_STEP_SUMMARY

            - name: Upload build artifact
              uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4 # v5.0.0
              with:
                  name: build-artifact
                  path: build-artifact.zip
                  retention-days: 1
                  compression-level: 0 # Already compressed

    release:
        name: Create Release
        runs-on: ubuntu-latest
        needs: [build-manual]
        if: |
            always() &&
            (needs.build-manual.result == 'success' || needs.build-manual.result == 'skipped')
        env:
            ARTIFACT: ''
            VERSION: ''
            RELEASE_NAME: ''
        steps:
            - name: Harden Runner
              uses: step-security/harden-runner@91182cccc01eb5e619899d80e4e971d6181294a7 # v2.10.1
              with:
                  disable-sudo: true
                  egress-policy: block
                  allowed-endpoints: >
                      api.github.com:443
                      github.com:443
                      mise.jdx.dev:443
                      objects.githubusercontent.com:443
                      registry.npmjs.org:443
                      uploads.github.com:443
                      fulcio.sigstore.dev:443
                      rekor.sigstore.dev:443
                      tuf-repo-cdn.sigstore.dev:443
                      keys.openpgp.org:443

            - name: Checkout repository
              uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
              with:
                  fetch-depth: 0
                  ref: ${{ github.event_name == 'workflow_dispatch' && github.ref || inputs.branch }}

            - name: Install mise
              uses: jdx/mise-action@f8dfbcc150159126838e44b882bf34bd98fd90f3 # v2.1.0
              with:
                  install_args: --yes

            - name: Download build artifact
              uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16 # v4.1.8
              with:
                  name: ${{ github.event_name == 'workflow_dispatch' && 'build-artifact' || inputs.artifact-name }}

            - name: Determine version and release type
              id: version
              run: |
                  # Determine branch based on event type
                  if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
                      BRANCH="${{ github.ref_name }}"
                      IS_MANUAL=true
                  else
                      BRANCH="${{ inputs.branch }}"
                      IS_MANUAL=false
                  fi

                  # Get short commit hash for build metadata
                  SHORT_SHA=$(git rev-parse --short HEAD)

                  if [[ "$IS_MANUAL" == "true" ]]; then
                      # For manual triggers, create a prerelease with build metadata
                      BASE_VERSION=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.1.0")
                      # Remove 'v' prefix
                      BASE_VERSION_NUM=${BASE_VERSION#v}
                      IFS='.' read -ra VERSION_PARTS <<< "$BASE_VERSION_NUM"
                      MAJOR=${VERSION_PARTS[0]}
                      MINOR=${VERSION_PARTS[1]}
                      PATCH=${VERSION_PARTS[2]%%[-+]*}
                      NEXT_PATCH=$((PATCH + 1))
                      TIMESTAMP=$(date +%Y%m%d%H%M%S)
                      # Create version with prerelease and build metadata: v0.1.1-dev.20251106123456+abc1234
                      VERSION="v${MAJOR}.${MINOR}.${NEXT_PATCH}-dev.${TIMESTAMP}+${SHORT_SHA}"
                      IS_PRERELEASE=true
                      RELEASE_NAME="fahrenheight-${VERSION}"
                  elif [[ "$BRANCH" == "main" ]]; then
                      # For main branch, get the latest tag or create initial version
                      VERSION=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.1.0")
                      IS_PRERELEASE=false
                      RELEASE_NAME="fahrenheight-${VERSION}"
                  elif [[ "$BRANCH" == "next" ]]; then
                      # For next branch, create a prerelease version
                      BASE_VERSION=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.1.0")
                      # Remove 'v' prefix, increment patch, add prerelease
                      BASE_VERSION_NUM=${BASE_VERSION#v}
                      IFS='.' read -ra VERSION_PARTS <<< "$BASE_VERSION_NUM"
                      MAJOR=${VERSION_PARTS[0]}
                      MINOR=${VERSION_PARTS[1]}
                      PATCH=${VERSION_PARTS[2]%%[-+]*}
                      NEXT_PATCH=$((PATCH + 1))
                      TIMESTAMP=$(date +%Y%m%d%H%M%S)
                      VERSION="v${MAJOR}.${MINOR}.${NEXT_PATCH}-next.${TIMESTAMP}"
                      IS_PRERELEASE=true
                      RELEASE_NAME="fahrenheight-${VERSION}"
                  else
                      echo "Error: Unexpected branch $BRANCH"
                      exit 1
                  fi

                  echo "version=$VERSION" >> $GITHUB_OUTPUT
                  echo "is_prerelease=$IS_PRERELEASE" >> $GITHUB_OUTPUT
                  echo "release_name=$RELEASE_NAME" >> $GITHUB_OUTPUT
                  echo "branch=$BRANCH" >> $GITHUB_OUTPUT

                  echo "VERSION=$VERSION" >> $GITHUB_ENV
                  echo "RELEASE_NAME=$RELEASE_NAME" >> $GITHUB_ENV

                  echo "## ðŸ“¦ Release Information" >> $GITHUB_STEP_SUMMARY
                  echo "- **Version:** $VERSION" >> $GITHUB_STEP_SUMMARY
                  echo "- **Branch:** $BRANCH" >> $GITHUB_STEP_SUMMARY
                  echo "- **Prerelease:** $IS_PRERELEASE" >> $GITHUB_STEP_SUMMARY
                  echo "- **Manual Trigger:** $IS_MANUAL" >> $GITHUB_STEP_SUMMARY

            - name: Rename build artifact
              run: |
                  # Rename the zip file to include version
                  mv build-artifact.zip "${RELEASE_NAME}.zip"
                  echo "ARTIFACT=${RELEASE_NAME}.zip" >> $GITHUB_ENV
                  echo "Renamed artifact to: ${RELEASE_NAME}.zip"

            - name: Create checksums
              run: |
                  # Use mise to create checksums
                  mise run create-checksums "${RELEASE_NAME}.zip"

                  echo "## ðŸ“‹ Checksums Created" >> $GITHUB_STEP_SUMMARY
                  echo '```' >> $GITHUB_STEP_SUMMARY
                  cat SHA256SUMS.txt >> $GITHUB_STEP_SUMMARY
                  echo '```' >> $GITHUB_STEP_SUMMARY

            - name: Import GPG key
              uses: crazy-max/ghaction-import-gpg@01dd5d3ca463c7f10f7f4f7b4f177225ac661ee4 # v6.1.0
              with:
                  gpg_private_key: ${{ secrets.GPG_PRIVATE_KEY }}
                  passphrase: ${{ secrets.GPG_KEY_PASSPHRASE }}
                  git_user_signingkey: true
                  git_commit_gpgsign: true
                  git_tag_gpgsign: true
                  trust_level: ultimate

            - name: Sign artifact with GPG
              env:
                  GPG_KEY_PASSPHRASE: ${{ secrets.GPG_KEY_PASSPHRASE }}
              run: |
                  echo "Signing ${ARTIFACT} with GPG"
                  echo "$GPG_KEY_PASSPHRASE" | gpg --batch --yes --passphrase-fd 0 \
                      --detach-sign --armor "${ARTIFACT}"

                  echo "GPG signature created: ${ARTIFACT}.asc"

                  # Verify signature
                  gpg --verify "${ARTIFACT}.asc" "${ARTIFACT}"

                  echo "## ðŸ” GPG Signature Verified" >> $GITHUB_STEP_SUMMARY

            - name: Sign checksums with GPG
              env:
                  GPG_KEY_PASSPHRASE: ${{ secrets.GPG_KEY_PASSPHRASE }}
              run: |
                  echo "Signing SHA256SUMS.txt with GPG"
                  echo "$GPG_KEY_PASSPHRASE" | gpg --batch --yes --passphrase-fd 0 \
                      --detach-sign --armor SHA256SUMS.txt

                  echo "GPG signature created: SHA256SUMS.txt.asc"

                  # Verify signature
                  gpg --verify SHA256SUMS.txt.asc SHA256SUMS.txt

                  echo "## ðŸ” Checksum Signature Verified" >> $GITHUB_STEP_SUMMARY

            - name: Generate SLSA attestations
              uses: actions/attest-build-provenance@1c608d11d69870c2092266b3f9a6f3abbf17002c # v1.4.3
              with:
                  subject-path: |
                      ${{ env.ARTIFACT }}
                      SHA256SUMS.txt

            - name: Generate changelog
              id: changelog
              run: |
                  VERSION="${{ steps.version.outputs.version }}"
                  BRANCH="${{ steps.version.outputs.branch }}"
                  IS_PRERELEASE="${{ steps.version.outputs.is_prerelease }}"
                  ARTIFACT="${ARTIFACT}"
                  IS_MANUAL="${{ github.event_name == 'workflow_dispatch' }}"

                  # Get short commit hash for build metadata
                  SHORT_SHA=$(git rev-parse --short HEAD)

                  # Get previous tag for changelog generation
                  PREV_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")

                  # Generate changelog using cog with appropriate options
                  if [[ "$IS_MANUAL" == "true" ]]; then
                      # For manual triggers, use --build option with short SHA
                      if [[ -n "$PREV_TAG" ]]; then
                          cog changelog --at "$VERSION"  "$PREV_TAG..$VERSION" > release_notes.md || {
                              echo "# Release $VERSION" > release_notes.md
                              echo "" >> release_notes.md
                              echo "Manual release build from commit: \`$SHORT_SHA\`" >> release_notes.md
                          }
                      else
                          cog changelog --at "$VERSION"  > release_notes.md || {
                              echo "# Release $VERSION" > release_notes.md
                              echo "" >> release_notes.md
                              echo "Manual release build from commit: \`$SHORT_SHA\`" >> release_notes.md
                          }
                      fi
                  else
                      # For automated releases, use standard changelog generation
                      if [[ -n "$PREV_TAG" ]]; then
                          PREV_TAG="$PREV_TAG" mise run changelog > release_notes.md
                      else
                          mise run changelog > release_notes.md
                      fi
                  fi

                  # Add verification instructions
                  cat >> release_notes.md << EOF

                  ## Verification

                  ### Verify GPG Signature

                  \`\`\`bash
                  # Download the release artifact and signature
                  wget https://github.com/${{ github.repository }}/releases/download/\${VERSION}/\${ARTIFACT}
                  wget https://github.com/${{ github.repository }}/releases/download/\${VERSION}/\${ARTIFACT}.asc

                  # Import the public key (if not already imported)
                  gpg --keyserver keys.openpgp.org --recv-keys <KEY_ID>

                  # Verify the signature
                  gpg --verify \${ARTIFACT}.asc \${ARTIFACT}
                  \`\`\`

                  ### Verify Checksums

                  \`\`\`bash
                  # Download checksums
                  wget https://github.com/${{ github.repository }}/releases/download/\${VERSION}/SHA256SUMS.txt

                  # Verify SHA256
                  sha256sum -c SHA256SUMS.txt
                  \`\`\`

                  ### Verify SLSA Attestation

                  \`\`\`bash
                  # Install GitHub CLI if not already installed
                  # https://cli.github.com/

                  # Verify attestation
                  gh attestation verify \${ARTIFACT} --repo ${{ github.repository }}
                  \`\`\`
                  EOF

                  echo "## ðŸ“ Changelog Generated" >> $GITHUB_STEP_SUMMARY
                  echo "Release notes created for version: $VERSION" >> $GITHUB_STEP_SUMMARY

            - name: Create GitHub Release
              uses: softprops/action-gh-release@c062e08bd532815e2082a85e87e3ef29c3e6d191 # v2.0.8
              with:
                  tag_name: ${{ steps.version.outputs.version }}
                  name: ${{ steps.version.outputs.release_name }}
                  body_path: release_notes.md
                  draft: false
                  prerelease: ${{ steps.version.outputs.is_prerelease }}
                  files: |
                      ${{ env.ARTIFACT }}
                      ${{ env.ARTIFACT }}.asc
                      SHA256SUMS.txt
                      SHA256SUMS.txt.asc
                  fail_on_unmatched_files: true
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

            - name: Release Summary
              run: |
                  VERSION="${{ steps.version.outputs.version }}"
                  BRANCH="${{ steps.version.outputs.branch }}"
                  IS_PRERELEASE="${{ steps.version.outputs.is_prerelease }}"

                  echo "## âœ… Release Created Successfully" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "**Version:** ${VERSION}" >> $GITHUB_STEP_SUMMARY
                  echo "**Branch:** ${BRANCH}" >> $GITHUB_STEP_SUMMARY
                  echo "**Prerelease:** ${IS_PRERELEASE}" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "### Artifacts" >> $GITHUB_STEP_SUMMARY
                  echo "- ðŸ“¦ Release Artifact: \`${ARTIFACT}\`" >> $GITHUB_STEP_SUMMARY
                  echo "- ðŸ” GPG Signature: \`${ARTIFACT}.asc\`" >> $GITHUB_STEP_SUMMARY
                  echo "- ðŸ“‹ Checksums: \`SHA256SUMS.txt\`" >> $GITHUB_STEP_SUMMARY
                  echo "- ðŸ” Checksum Signature: \`SHA256SUMS.txt.asc\`" >> $GITHUB_STEP_SUMMARY
                  echo "- ðŸ›¡ï¸ SLSA Attestations: Generated via GitHub" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "### Links" >> $GITHUB_STEP_SUMMARY
                  echo "- [Release Page](https://github.com/${{ github.repository }}/releases/tag/${VERSION})" >> $GITHUB_STEP_SUMMARY
                  echo "- [Changelog](https://github.com/${{ github.repository }}/blob/main/CHANGELOG.md)" >> $GITHUB_STEP_SUMMARY
